<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <!-- Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
    <link rel="alternate icon" href="/static/favicon.png" type="image/png">
      
      <!-- –î–ª—è Safari -->
    <link rel="mask-icon"  href="/static/favicon.svg" color="#291161"> 
    <link rel="stylesheet" href="/static/COR_Energy/energy.css">
    <link rel="stylesheet" href="/static/COR_ID_css/styles.css">
    <link rel="stylesheet" href="/static/COR_ID_css/modal.css">

    
    <title>COR-Energy</title>
    <script src="/static/COR_Energy/scripts.js"></script>
    <script src="/static/COR_ID_Js/general_fun.js"></script>
    <script src="/static/COR_Energy/xlsx.full.min.js"></script>
    <script src="/static/COR_Energy/chart.min.js"></script>

</head>
<body>
    <div class="energy-container">
        <div class="navigation-container">
            <button class="link-button" onclick="goBack('/static/COR_ID/mainscreen.html')" data-translate="back-link-text">&lt;&lt;&lt;–Ω–∞–∑–∞–¥&lt;&lt;&lt;</button>         
        </div>
        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div class="header-row">
            <h1>–û–±—ä–µ–∫—Ç—ã</h1>

            <div class="button-controls">
                <button onclick="addObject()" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>
            </div>
        </div>
        <div id="table-container" style="display: none;" class="objects-table-container">
            <table id="objects-table" class="objects-table">
                <thead>
                    <tr>
                        <!-- –£–±—Ä–∞–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ ID -->
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>   </th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ -->
    <div id="addObjectModal" class="modal" style="display: none;">
        <div class="modal-header">
            <div class="modal-buttons">
                <button class="modal-button close" data-action="close" id="closeAddObject">‚úñ</button>
            </div>
            <h3 style="margin-top:30; color:#291161;font-size: 17px;">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</h3>
        </div>
        <div class="modal-content">
            <div class="form">
                <label for="objectId">ID:</label>
                <input type="text" id="objectId" name="objectId" required>
            </div>

            <div class="form">
                <label for="objectName">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="objectName" name="objectName" required>
            </div>

            <div class="form">
                <label for="objectDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="objectDescription" name="objectDescription" required></textarea>
            </div>

            <div class="form">
                <label for="objectProtocol">–ü—Ä–æ—Ç–æ–∫–æ–ª:</label>
                <input type="text" id="objectProtocol" name="objectProtocol" required>
            </div>

            <div class="form">
                <label for="objectStatus">–°—Ç–∞—Ç—É—Å:</label>
                <select id="objectStatus" name="objectStatus" required>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                    <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
                </select>
            </div>

            <div class="form">
                <label for="objectStatus">–î–µ–π—Å—Ç–≤–∏—è:</label>
                
            </div>


            <button onclick="submitAddObjectForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>

     
       // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function loadObjects() {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const tableContainer = document.getElementById('table-container');
            const tableBody = document.getElementById('table-body');

            try {
                // UI ‚Äî –Ω–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏
                loadingElement.style.display = 'block';
                errorElement.style.display = 'none';
                tableContainer.style.display = 'none';

                const response = await fetch('/api/modbus/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                let objects = await response.json();

                // ‚úî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–µ–≤, –µ—Å–ª–∏ –±–µ–∫ –≤–µ—Ä–Ω—ë—Ç { data: [...] }
                if (!Array.isArray(objects)) {
                    if (Array.isArray(objects?.data)) {
                        objects = objects.data;
                    } else {
                        throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                    }
                }

                // UI ‚Äî –∫–æ–Ω–µ—Ü –∑–∞–≥—Ä—É–∑–∫–∏
                loadingElement.style.display = 'none';

                if (objects.length > 0) {
                    renderTable(objects);
                } else {
                    tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align:center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td>
                    </tr>`;
                }

                tableContainer.style.display = 'block';

            } catch (error) {
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.textContent = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`;
                console.error('Error loading objects:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
function renderTable(objects) {
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = '';

    objects.forEach(obj => {
        const row = document.createElement('tr');
        row.dataset.id = obj.id;

        let statusClass = 'status-unknown';
        let statusText = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

        if (obj.is_active === true) {
            statusClass = 'status-active';
            statusText = '–ê–∫—Ç–∏–≤–µ–Ω';
        } else if (obj.is_active === false) {
            statusClass = 'status-inactive';
            statusText = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
        }

        const modbusRegisters = obj.modbus_registers 
            ? JSON.stringify(obj.modbus_registers)
            : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

        row.innerHTML = `
            <td>${obj.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
            <td>${obj.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
            <td title="${modbusRegisters}">
                ${modbusRegisters.length > 50 ? modbusRegisters.substring(0, 50) + '...' : modbusRegisters}
            </td>
            <td class="${statusClass}">${statusText}</td>

            <td class="actions">
                <button class="more-btn">‚ãÆ</button>

                <div class="actions-menu">
                    <button class="action-edit">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.7474 11.9794V15.5793C15.7472 16.0886 15.5447 16.577 15.1846 16.9372C14.8244 
                            17.2974 14.336 17.4998 13.8266 17.5H4.42077C4.16761 17.4999 3.91696 17.4498 3.68323 
                            17.3525C3.4495 17.2552 3.2373 17.1127 3.05882 16.9332C2.88033 16.7537 2.73908 16.5406 
                            2.64319 16.3063C2.5473 16.072 2.49865 15.8211 2.50003 15.5679V6.1726C2.49853 5.91984 
                            2.5472 5.66929 2.64323 5.43548C2.73927 5.20166 2.88075 4.98923 3.05948 4.8105C3.23822 
                            4.63177 3.45065 4.49028 3.68446 4.39425C3.91827 4.29822 4.16882 4.24954 4.42158 
                            4.25105H8.02064M15.7473 7.56389L12.4353 4.25104M5.81121 13.0837V11.3283C5.81284 
                            11.0389 5.92797 10.7608 6.13147 10.5557L13.8598 2.82731C13.9624 2.72362 14.0845 
                            2.6413 14.2191 2.58511C14.3536 2.52893 14.498 2.5 14.6439 2.5C14.7897 2.5 14.9341 
                            2.52893 15.0687 2.58511C15.2032 2.6413 15.3253 2.72362 15.4279 2.82731L17.1719 
                            4.5713C17.2756 4.67385 17.3579 4.79594 17.4141 4.93052C17.4702 5.0651 17.4992 
                            5.20949 17.4992 5.35532C17.4992 5.50116 17.4702 5.64555 17.4141 5.78013C17.3579 
                            5.91471 17.2756 6.0368 17.1719 6.13935L9.44351 13.8677C9.23801 14.0718 8.96046 
                            14.1868 8.67084 14.188H6.9155C6.77042 14.1882 6.62673 14.1598 6.49265 14.1043C6.35858 
                            14.0489 6.23676 13.9676 6.13418 13.865C6.03159 13.7624 5.95026 13.6406 5.89484 
                            13.5065C5.83942 13.3724 5.811 13.2288 5.81121 13.0837Z" stroke="#5B4296" 
                            stroke-linecap="round" stroke-linejoin="round"/>
                        </svg> 
                         –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="action-pause">‚è∏ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button class="action-delete">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </td>
        `;

    
        const btn = row.querySelector('.more-btn');
        const menu = row.querySelector('.actions-menu');

        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllMenus();
            menu.classList.toggle('visible');
        });

        menu.querySelector('.action-edit').onclick = (e) => {
            e.stopPropagation();
            handleEdit(obj);
        };

        menu.querySelector('.action-pause').onclick = (e) => {
            e.stopPropagation();
            handleStop(obj);
        };

        menu.querySelector('.action-delete').onclick = (e) => {
            e.stopPropagation();
            handleDelete(obj);
        };

        // –ü–µ—Ä–µ—Ö–æ–¥ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É
        row.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;

            const userCorId = localStorage.getItem('COR-ID');  
            window.location.href = `/static/COR_Energy/object.html?userCorId=${userCorId}&object_Id=${obj.id}`;
        });

        tableBody.appendChild(row);
    });
}
        
        
        function editObject(id) {
            alert(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Å ID: ${id}`);
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        }
        
        function addObject() {
            const modal = document.getElementById('addObjectModal');
            modal.style.display = 'block';
        }


        function handleEdit(obj) {
            console.log("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:", obj.id, obj);
            // TODO –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        }

        function handleDelete(obj) {
            console.log("–£–¥–∞–ª–∏—Ç—å:", obj.id);
            // TODO –∑–∞–ø—Ä–æ—Å DELETE –Ω–∞ —Å–µ—Ä–≤–µ—Ä + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        }

        function handleStop(obj) {
            console.log("–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:", obj.id);
            // TODO –∑–∞–ø—Ä–æ—Å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—ä–µ–∫—Ç–∞
        }


        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }


        function closeAllMenus() {
        document.querySelectorAll('.actions-menu.visible')
            .forEach(menu => menu.classList.remove('visible'));
        }

        document.addEventListener('click', () => closeAllMenus());
        async function submitAddObjectForm() {
            const form = document.getElementById('addObjectForm');
            const formData = new FormData(form);

            const objectData = {
                id: formData.get('objectId'),
                name: formData.get('objectName'),
                description: formData.get('objectDescription'),
                protocol: formData.get('objectProtocol'),
                status: formData.get('objectStatus')
            };

            try {
                const response = await fetch('/api/modbus/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(objectData)
                });

                if (response.ok) {
                    alert('–û–±—ä–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    closeModal('addObjectModal');
                    loadObjects(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –æ–±—ä–µ–∫—Ç–æ–≤
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞.');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞.');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –∏–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ)
        function refreshData() {
            loadObjects();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadObjects();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
            initModalControls('addObjectModal');
            makeModalDraggable('addObjectModal');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('error', function(e) {
            console.error('Page error:', e.error);
        });

  
    </script>
</body>
</html>