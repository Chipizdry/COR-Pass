<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <!-- Favicon SVG (–æ—Å–Ω–æ–≤–Ω–æ–π) -->
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    
      <!-- Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
    <link rel="alternate icon" href="/static/favicon.png" type="image/png">
      
      <!-- –î–ª—è Safari -->
    <link rel="mask-icon"  href="/static/favicon.svg" color="#291161"> 
    <link rel="stylesheet" href="/static/COR_Energy/energy.css">
    <link rel="stylesheet" href="/static/COR_ID_css/styles.css">
    <link rel="stylesheet" href="/static/COR_ID_css/modal.css">

    
    <title>COR-Energy</title>
    <script src="/static/COR_Energy/scripts.js"></script>
    <script src="/static/COR_ID_Js/general_fun.js"></script>
    <script src="/static/COR_Energy/xlsx.full.min.js"></script>
    <script src="/static/COR_Energy/chart.min.js"></script>

</head>
<body>
    <div class="energy-container">
        <h1>Energetic Object</h1>
        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div class="schedule-controls">
           
            <button onclick="addObject()" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>
        </div>
        <div id="table-container" style="display: none;" class="schedule-table-container">
            <table id="objects-table" class="schedule-table">
                <thead>
                    <tr>
                        <!-- –£–±—Ä–∞–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ ID -->
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ -->
    <div id="addObjectModal" class="modal" style="display: none;">
        <div class="modal-header">
            <div class="modal-buttons">
                <button class="modal-button close" data-action="close" id="closeAddObject">‚úñ</button>
            </div>
            <h3 style="margin-top:30; color:#291161;font-size: 17px;">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</h3>
        </div>
        <div class="modal-content">
            <div class="form">
                <label for="objectId">ID:</label>
                <input type="text" id="objectId" name="objectId" required>
            </div>

            <div class="form">
                <label for="objectName">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="objectName" name="objectName" required>
            </div>

            <div class="form">
                <label for="objectDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="objectDescription" name="objectDescription" required></textarea>
            </div>

            <div class="form">
                <label for="objectProtocol">–ü—Ä–æ—Ç–æ–∫–æ–ª:</label>
                <input type="text" id="objectProtocol" name="objectProtocol" required>
            </div>

            <div class="form">
                <label for="objectStatus">–°—Ç–∞—Ç—É—Å:</label>
                <select id="objectStatus" name="objectStatus" required>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                    <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
                </select>
            </div>

            <div class="form">
                <label for="objectStatus">–î–µ–π—Å—Ç–≤–∏—è:</label>
                
            </div>


            <button onclick="submitAddObjectForm()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
       // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function loadObjects() {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const tableContainer = document.getElementById('table-container');
            const tableBody = document.getElementById('table-body');

            try {
                // UI ‚Äî –Ω–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏
                loadingElement.style.display = 'block';
                errorElement.style.display = 'none';
                tableContainer.style.display = 'none';

                const response = await fetch('/api/modbus/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                let objects = await response.json();

                // ‚úî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–µ–≤, –µ—Å–ª–∏ –±–µ–∫ –≤–µ—Ä–Ω—ë—Ç { data: [...] }
                if (!Array.isArray(objects)) {
                    if (Array.isArray(objects?.data)) {
                        objects = objects.data;
                    } else {
                        throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                    }
                }

                // UI ‚Äî –∫–æ–Ω–µ—Ü –∑–∞–≥—Ä—É–∑–∫–∏
                loadingElement.style.display = 'none';

                if (objects.length > 0) {
                    renderTable(objects);
                } else {
                    tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align:center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td>
                    </tr>`;
                }

                tableContainer.style.display = 'block';

            } catch (error) {
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.textContent = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`;
                console.error('Error loading objects:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
function renderTable(objects) {
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = '';

    objects.forEach(obj => {
        const row = document.createElement('tr');
        row.dataset.id = obj.id; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ–±—ä–µ–∫—Ç–∞ –≤ —Å—Ç—Ä–æ–∫—É

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        let statusClass = 'status-unknown';
        let statusText = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

        if (obj.is_active === true) {
            statusClass = 'status-active';
            statusText = '–ê–∫—Ç–∏–≤–µ–Ω';
        } else if (obj.is_active === false) {
            statusClass = 'status-inactive';
            statusText = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
        }

        // –§–æ—Ä–º–∞—Ç Modbus —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
        const modbusRegisters = obj.modbus_registers 
            ? JSON.stringify(obj.modbus_registers)
            : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

            row.innerHTML = `
            <td>${obj.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
            <td>${obj.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
            <td title="${modbusRegisters}">
                ${modbusRegisters.length > 50 ? modbusRegisters.substring(0, 50) + '...' : modbusRegisters}
            </td>
            <td class="${statusClass}">${statusText}</td>

            <!-- ‚úÖ –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏ -->
            <td class="actions">
                <button class="btn-icon btn-edit"   title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                <button class="btn-icon btn-delete" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                <button class="btn-icon btn-stop"   title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">‚èπÔ∏è</button>
            </td>
        `;

        // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
        row.querySelector('.btn-edit').addEventListener('click', () => handleEdit(obj));
        row.querySelector('.btn-delete').addEventListener('click', () => handleDelete(obj));
        row.querySelector('.btn-stop').addEventListener('click', () => handleStop(obj));


        // ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–æ–∫)
            row.addEventListener('click', (e) => {
            if (e.target.closest('button')) return; // –Ω–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫–∏
            const userCorId = localStorage.getItem('COR-ID');  
            const objectId = obj.id;
            window.location.href = `/static/COR_Energy/object.html?userCorId=${userCorId}&object_Id=${objectId}`;
        });


        tableBody.appendChild(row);
    });
}
        
        
        function editObject(id) {
            alert(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Å ID: ${id}`);
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        }
        
        function addObject() {
            const modal = document.getElementById('addObjectModal');
            modal.style.display = 'block';
        }


        function handleEdit(obj) {
            console.log("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:", obj.id, obj);
            // TODO –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        }

        function handleDelete(obj) {
            console.log("–£–¥–∞–ª–∏—Ç—å:", obj.id);
            // TODO –∑–∞–ø—Ä–æ—Å DELETE –Ω–∞ —Å–µ—Ä–≤–µ—Ä + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        }

        function handleStop(obj) {
            console.log("–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:", obj.id);
            // TODO –∑–∞–ø—Ä–æ—Å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—ä–µ–∫—Ç–∞
        }


        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        async function submitAddObjectForm() {
            const form = document.getElementById('addObjectForm');
            const formData = new FormData(form);

            const objectData = {
                id: formData.get('objectId'),
                name: formData.get('objectName'),
                description: formData.get('objectDescription'),
                protocol: formData.get('objectProtocol'),
                status: formData.get('objectStatus')
            };

            try {
                const response = await fetch('/api/modbus/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(objectData)
                });

                if (response.ok) {
                    alert('–û–±—ä–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    closeModal('addObjectModal');
                    loadObjects(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –æ–±—ä–µ–∫—Ç–æ–≤
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞.');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞.');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –∏–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ)
        function refreshData() {
            loadObjects();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadObjects();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
            initModalControls('addObjectModal');
            makeModalDraggable('addObjectModal');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('error', function(e) {
            console.error('Page error:', e.error);
        });
    </script>
</body>
</html>