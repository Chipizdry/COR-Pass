<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Recipes Page</title>
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/general.css">
    <link rel="stylesheet" href="../../css/header.css">

    <!-- приховуємо сторінку, щоб переклалось без FOUC -->
    <style>
        html.i18n-loading body {
            visibility: hidden;
        }
    </style>

    <script>
        document.documentElement.classList.add('i18n-loading');
    </script>

    <!-- Захист від зависання і пустої сторінки! -->
    <script>
        function removeI18nMask() {
              document.documentElement.classList.remove('i18n-loading');
        }
            // Якщо translation.js викликає applySavedLanguage() — знімай після неї
        document.addEventListener('i18n:ready', removeI18nMask);
            // fallback: знімаємо при повному завантаженні сторінки
        window.addEventListener('load', removeI18nMask, { once: true });
            // запасний таймер, якщо переклад завис
        setTimeout(removeI18nMask, 2500);
    </script>
    <!-- підключаємо переклад та видаляємо зайвий клас -->
    <script src="../../../COR_ID_Js/translation.js"></script>

    <noscript>
        <style>html.i18n-loading body { visibility: visible !important; }</style>
    </noscript>

    <link rel="stylesheet" href="../../css/infoPlate.css">
    <link rel="stylesheet" href="../../css/comments.css">
    <link rel="stylesheet" href="../../css/glass.css">
    <link rel="stylesheet" href="../../css/modal.css">
    <link rel="stylesheet" href="../../css/doctorSign.css">
    <link rel="stylesheet" href="../../css/myCard/general.css">
    <link rel="stylesheet" href="../../css/myCard/ophthalmology-recipes.css">
    <link rel="stylesheet" href="../../../COR_ID_css/modal.css">
</head>
<body>

<div class="glassPageWrapper df fdc">
    <div class="header-container">
        <div class="header-row top">
            <div class="role-container" style="margin-right: 20px">
                <a href="/static/COR_ID/mainscreen.html" class="role-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 11.6067L11.1031 2.86212C11.2208 2.74732 11.3607 2.65625 11.5146 2.59411C11.6685 2.53198 11.8334 2.5 12 2.5C12.1666 2.5 12.3315 2.53198 12.4854 2.59411C12.6393 2.65625 12.7792 2.74732 12.8969 2.86212L23 11.6067M3.53846 9.40792V20.2633C3.53846 20.946 4.10708 21.5 4.80769 21.5H9.46154V16.1411C9.46154 15.4585 10.0302 14.9045 10.7308 14.9045H13.2692C13.9698 14.9045 14.5385 15.4585 14.5385 16.1411V21.5H19.1923C19.8929 21.5 20.4615 20.946 20.4615 20.2633V9.40792" stroke="#7527B2" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </a>
            </div>
            <div class="search-container">
                <input type="text" placeholder="Search" data-translate="searchPlaceholder">
                <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M11.2 5.60001C8.10722 5.60001 5.60001 8.10722 5.60001 11.2C5.60001 14.2928 8.10722 16.8001 11.2 16.8001C12.7087 16.8001 14.0781 16.2035 15.085 15.2333C15.1061 15.2058 15.1292 15.1794 15.1544 15.1543C15.1795 15.1291 15.2059 15.106 15.2334 15.0849C16.2035 14.078 16.8 12.7087 16.8 11.2C16.8 8.10722 14.2928 5.60001 11.2 5.60001ZM16.8256 15.6942C17.8109 14.4624 18.4001 12.9 18.4001 11.2C18.4001 7.22357 15.1765 4 11.2 4C7.22356 4 4 7.22357 4 11.2C4 15.1765 7.22356 18.4001 11.2 18.4001C12.9001 18.4001 14.4625 17.8109 15.6942 16.8255L18.6344 19.7657C18.9468 20.0781 19.4533 20.0781 19.7658 19.7657C20.0782 19.4533 20.0782 18.9467 19.7658 18.6343L16.8256 15.6942Z"
                          fill="#B1A1DA"/>
                </svg>
            </div>
            <div class="role-container">
                <button class="role-icon" id="goToCases" aria-label="User roles">
                    <svg class="icon-group" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M14.2666 11.1279C16.1699 11.128 17.7128 12.6709 17.7129 14.5742V20.4512C17.7127 20.8636 17.3783 21.1982 16.9658 21.1982H7.03418C6.62172 21.1982 6.28734 20.8636 6.28711 20.4512V14.5742C6.28721 12.6709 7.83002 11.1279 9.7334 11.1279H14.2666ZM5.53516 13.1729C5.38681 13.6154 5.28731 14.0804 5.28711 14.5723H3.44629C2.31795 14.5724 1.40039 15.4908 1.40039 16.6191V19.7979H5.28711V20.4502C5.28711 20.7184 5.35253 20.97 5.46094 21.1973H0.74707C0.334473 21.1973 0 20.8628 0 20.4502V16.6191C0 14.7158 1.54293 13.173 3.44629 13.1729H5.53516ZM20.5537 13.1729C22.457 13.173 24 14.7158 24 16.6191V20.4502C24 20.8628 23.6655 21.1972 23.2529 21.1973H18.5391C18.6475 20.97 18.7129 20.7183 18.7129 20.4502V19.7979H22.5996V16.6191C22.5996 15.4908 21.682 14.5724 20.5537 14.5723H18.7129C18.7127 14.0804 18.6132 13.6154 18.4648 13.1729H20.5537ZM9.7334 12.5283C8.60504 12.5283 7.68662 13.4459 7.68652 14.5742V19.7979H16.3125V14.5742C16.3124 13.4459 15.3949 12.5284 14.2666 12.5283H9.7334ZM4.55273 6.53711C6.13959 6.53711 7.42568 7.82339 7.42578 9.41016C7.42578 10.9971 6.13965 12.2832 4.55273 12.2832C2.96597 12.2831 1.67969 10.997 1.67969 9.41016C1.67979 7.82345 2.96603 6.53721 4.55273 6.53711ZM19.4473 6.53711C21.0339 6.53724 22.3202 7.82347 22.3203 9.41016C22.3203 10.997 21.034 12.2831 19.4473 12.2832C17.8604 12.2832 16.5742 10.9971 16.5742 9.41016C16.5743 7.82339 17.8605 6.53711 19.4473 6.53711ZM4.55273 7.9375C3.74056 7.9376 3.08018 8.59798 3.08008 9.41016C3.08008 10.2225 3.7405 10.8837 4.55273 10.8838C5.36511 10.8838 6.02637 10.2225 6.02637 9.41016C6.02627 8.59792 5.36505 7.9375 4.55273 7.9375ZM19.4473 7.9375C18.6349 7.9375 17.9737 8.59792 17.9736 9.41016C17.9736 10.2225 18.6349 10.8838 19.4473 10.8838C20.2595 10.8837 20.9199 10.2225 20.9199 9.41016C20.9198 8.598 20.2594 7.93763 19.4473 7.9375ZM12 2.80273C13.991 2.80283 15.6053 4.41628 15.6055 6.40723C15.6055 8.39832 13.9911 10.0126 12 10.0127C10.0089 10.0127 8.39453 8.39838 8.39453 6.40723C8.3947 4.41622 10.009 2.80273 12 2.80273ZM12 4.20215C10.7841 4.20215 9.79509 5.19136 9.79492 6.40723C9.79492 7.62323 10.784 8.61328 12 8.61328C13.2159 8.61318 14.2051 7.62317 14.2051 6.40723C14.2049 5.19142 13.2158 4.20225 12 4.20215Z"
                              fill="#7527B2"/>
                    </svg>
                </button>
                <div class="role-toggle">
                    <button class="role-btn doc active" data-translate="doc">Лікар</button>
                    <button class="role-btn lab" data-translate="lab">Лаборант</button>
                </div>
            </div>
        </div>
        <div class="header-row bottom">
            <div>
                <div class="tabs">
                    <button class="tab medCardPage active" data-translate="medCardPage">Медкарта</button>
                    <button class="tab directionPage" data-translate="direction">Направлення</button>
                    <button class="tab tenderloinPage" data-translate="tenderloin">Вирізка</button>
                    <button class="tab glassPage" data-translate="glass">Скельця</button>
                    <button class="tab conclusionPage" data-translate="conclusion">Заключення</button>
                    <button class="tab explorationPage" data-translate="exploration">Дослідження</button>
                </div>
            </div>
            <div class="meta-info">
                <div id="reportOwnerInfo">
                </div>
                <div>
                    <span id="searchCaseId"></span>
                </div>
                <div id="userName"></div>
                <div id="userGender"></div>
                <div id="userAge"></div>
            </div>
        </div>
    </div>
    <div class="glassPageContent df jcsb custom-scroll" style="overflow-y: hidden;overflow-x: auto;">
        <div class="left">
            <div class="top borderRadiusLeft df aic">
                <div class="glassPageRevert" style="display: none">
                    <img src="../../assets/arrow.svg" alt="arrow">
                </div>
                <div data-translate="specializations">
                    Спеціальності
                </div>
            </div>
            <div class="bottom">
                <div class="specificMed">
                    <div data-id="pathomorphology" class="specificMedItem" data-translate="pathomorphology">Патоморфологія</div>
                    <div data-id="" class="specificMedItem" data-translate="endocrinology">Ендокринологія</div>
                    <div data-id="" class="specificMedItem" data-translate="cardiology">Кардіологія</div>
                    <div data-id="ophthalmology" class="specificMedItem active" data-translate="ophthalmology">Офтальмологія</div>
                </div>
            </div>
        </div>
        <div class="middle df fdc">
            <div class="top df aic jcsb">
                <div class="df custom-scroll" style="flex-wrap: nowrap;overflow: auto;width: 100%; height: 72px;">
                    <div class="centralItem">
                        <p data-translate="latestRecords">Останні записи</p>
                    </div>
                    <div class="centralItem">
                        <p data-translate="extracts_Conclusions">Виписки/Заключення</p>
                    </div>
                    <div class="centralItem active">
                        <p data-translate="recipes_Nutrients">Рецепти/Нутріенти</p>
                    </div>
                    <div class="centralItem">
                        <p data-translate="prescription">Призначення</p>
                    </div>
                    <div class="centralItem">
                        <p data-translate="diagnosis">Діагноз</p>
                    </div>
                    <div class="centralItem">
                        <p data-translate="vaccination">Щеплення</p>
                    </div>
                    <div class="centralItem">
                        <p data-translate="exploration">Дослідження</p>
                    </div>
                </div>
            </div>
            <div class="bottom df custom-scroll">
                <div style="width: 100%">
                    <div class="recipesWrapper">
                        <form action="">
                            <div class="recipesTop custom-scroll">
                                <div class="recipesTopCol">
                                    <div class="recipesTopRow white" data-translate="settings">Параметри</div>
                                    <div class="recipesTopRow white" data-translate="od">OD (Праве)</div>
                                    <div class="recipesTopRow white" data-translate="os">OS (Ліве)</div>
                                </div>
                                <div class="recipesTopCol">
                                    <div class="recipesTopRow white">Sph</div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="od_sph" value="-20.00" min="-20" max="20"  step="0.25">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="os_sph" value="20.00" min="-20" max="20"  step="0.25">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="recipesTopCol">
                                    <div class="recipesTopRow white">Cyl</div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="od_cyl" value="-6.00" min="-6" max="6"  step="0.25">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="os_cyl" value="6.00" min="-6" max="6"  step="0.25">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="recipesTopCol">
                                    <div class="recipesTopRow white">Ax</div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="od_ax" value="0">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="os_ax" value="0">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="recipesTopCol">
                                    <div class="recipesTopRow white">Prism</div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="od_prism" value="0.00">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="os_prism" value="0.00">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="recipesTopCol">
                                    <div class="recipesTopRow white">Base</div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup">
                                            <div class="recipesTopPicker" data-id="od_base">
                                                <div class="recipesTopPickerName" data-translate="select">
                                                    Оберіть
                                                </div>
                                                <div>
                                                    <img src="../../assets/arrow.svg" alt="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup">
                                            <div class="recipesTopPicker" data-id="os_base">
                                                <div class="recipesTopPickerName" data-translate="select">
                                                    Оберіть
                                                </div>
                                                <div>
                                                    <img src="../../assets/arrow.svg" alt="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="recipesTopCol">
                                    <div class="recipesTopRow white">Add</div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="od_add" value="-0.75" step="0.25">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="recipesTopRow">
                                        <div class="recipesTopGroup input">
                                            <div class="recipesTopGroupImg minus">
                                                <img src="../../assets/minus.svg" alt="minus">
                                            </div>
                                            <input type="text" name="os_add" value="0.75" step="0.25">
                                            <div class="recipesTopGroupImg plus">
                                                <img src="../../assets/plus.svg" alt="minus">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="recipesBottom">
                                <div class="recipesBottomCol">
                                    <div class="recipesBottomTitle" data-translate="glassesPurpose">
                                        Призначення окулярів
                                    </div>
                                    <div class="recipesBottomPicker" data-id="glasses_purpose">
                                        <div class="recipesBottomPickerItem active" data-id="glasses_for_reading" data-translate="">Для читання</div>
                                        <div class="recipesBottomPickerItem" data-id="glasses_for_distance" data-translate="forDistance">Для далі</div>
                                        <div class="recipesBottomPickerItem" data-id="glasses_for_constant_wear" data-translate="forConstantWear">Для постійного носіння</div>
                                    </div>
                                    <div class="recipesBottomTitle" data-translate="recipesDate">
                                        Дата виписки рецепта
                                    </div>
                                    <div class="recipesBottomDate">
                                        <div class="recipesBottomDateGroup">
                                            <input type="date" name="issue_date" placeholder="дд.мм.рррр">
                                        </div>
                                    </div>
                                </div>
                                <div class="recipesBottomCol">
                                    <div class="recipesBottomTitle" data-translate="glassesType">
                                        Тип окулярiв
                                    </div>
                                    <div class="recipesBottomPicker" data-id="glasses_type">
                                        <div class="recipesBottomPickerItem active" data-id="monofocal_glasses" data-translate="bifocal">Біфокальні</div>
                                        <div class="recipesBottomPickerItem" data-id="bifocal_glasses" data-translate="multifocal">Мультифокальні</div>
                                        <div class="recipesBottomPickerItem" data-id="multifocal_glasses" data-translate="monofocal">Монофокальнi</div>
                                    </div>
                                    <div class="recipesBottomTitle" data-translate="durationOfRecipe">
                                        Термін дії рецепта
                                    </div>
                                    <div class="recipesBottomInput">
                                        <div class="recipesBottomInputGroup">
                                            <input type="number" name="term_months" placeholder="Введіть число" data-translate="enterNumber">
                                            <div data-translate="months">
                                                місяців
                                            </div>

                                            <script>
                                            document.addEventListener('DOMContentLoaded', () => {
                                                const input = document.getElementById('termMonthsInput');
                                                const label = document.getElementById('monthsLabel');

                                                input.addEventListener('input', () => {
                                                    const val = Math.abs(+input.value || 0);
                                                    const lang = getSavedLang();
                                                    const dict = translations?.[lang] || {};
                                                    let base = dict.months || 'місяців';
                                                    if (lang === 'uk') {
                                                        if (val === 1) base = 'місяць';
                                                        else if (val > 1 && val < 5) base = 'місяці';
                                                        else base = 'місяців';
                                                    }
                                                    else if (lang === 'ru') {
                                                        if (val === 1) base = 'месяц';
                                                        else if (val > 1 && val < 5) base = 'месяца';
                                                        else base = 'месяцев';
                                                    }
                                                    else if (lang === 'en') {
                                                        base = val === 1 ? 'month' : 'months';
                                                    }
                                                    else if (lang === 'zh') {
                                                        base = '个月';
                                                    }
                                                        label.textContent = base;
                                                    });
                                                });
                                            </script>
                                        </div>
                                    </div>
                                </div>
                                <div class="recipesBottomCol">
                                    <div class="recipesBottomTitle" data-translate="note">
                                        Примітка
                                    </div>
                                    <div class="recipesBottomTextarea">
                                        <div class="recipesBottomTextareaGroup">
                                            <textarea name="note" placeholder="Введіть додаткову інформацію " data-translate="enterAdditionalInfo"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="text" value="glasses_for_reading" name="glasses_purpose" hidden>
                            <input type="text" value="monofocal_glasses" name="glasses_type" hidden>
                            <input type="text" name="od_base" hidden>
                            <input type="text" name="os_base" hidden>
                            <div class="recipesSubmit" id="doctorSignModalBtn" data-translate="signRecipe">
                                Підписати рецепт
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="right" id="personalInfo">

        </div>
    </div>
    <div id="doctorSign" class="modalCustom">
        <div class="modalWrapper">
            <div class="modalTitle" data-translate="signature">Підпис</div>
            <div class="modalContent">
                <div>
                    <div class="doctorSignImgList open">
                        <div>
                            <label for="signFile" class="doctorSignUpload">
                                <svg width="800px" height="800px" viewBox="0 0 24 24" fill="none"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 12L12 12M12 12L9 12M12 12L12 9M12 12L12 15" stroke="#1C274C"
                                          stroke-width="1.5" stroke-linecap="round"/>
                                    <path d="M7 3.33782C8.47087 2.48697 10.1786 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 10.1786 2.48697 8.47087 3.33782 7"
                                          stroke="#1C274C" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                <input type="file" id="signFile" accept="image/*" style="display: none;">
                            </label>
                            <div class="doctorSignImgWrapper df fdc">

                            </div>
                        </div>
                        <div class="df aic jcc gap4">
                            <div class="doctorSignButton" data-translate="sign">
                                Sign
                            </div>
                            <div id="openCreateDoctorSign" class="doctorSignButton" data-translate="createDoctorSign">
                                Create signature
                            </div>
                        </div>
                    </div>
                    <div class="doctorSignCreate">
                        <div id="clearDoctorSign">
                            <svg xmlns="http://www.w3.org/2000/svg" width="512px" height="512px" viewBox="0 0 512 512">
                                <path d="M469 472c0,0 0,0 0,0l-462 0c-3,0 -6,-2 -7,-5 -1,-3 1,-6 3,-8l103 -69c1,-1 2,-1 4,-1l7 0c5,10 11,19 19,27 21,20 48,32 77,32 29,0 57,-12 77,-32l27 -27 59 0c1,0 3,0 4,1l92 69c2,1 3,3 3,6 0,4 -3,7 -6,7z"
                                      fill="#6C00FF"/>
                                <path d="M213 439c-27,0 -52,-10 -70,-29 -39,-39 -39,-103 0,-142l12 -12 142 141 -13 13c-19,19 -44,29 -71,29zm77 -95c-2,0 -3,-1 -5,-2l-75 -75c-2,-3 -2,-7 0,-10l102 -102c2,-1 3,-2 5,-2 2,0 4,1 5,2l75 75c1,2 2,3 2,5 0,2 -1,4 -2,5l-102 102c-1,1 -3,2 -5,2zm-65 -82l65 66 93 -93 -66 -65 -92 92zm-60 -16l136 -136 141 141 -136 136 -141 -141zm146 -146l58 -58c1,-1 3,-2 5,-2 1,0 3,1 4,2l132 132c1,1 2,3 2,5 0,2 -1,3 -2,5l-58 58 -141 -142z"
                                      fill="#6C00FF"/>
                            </svg>
                        </div>
                        <div id="closeDoctorSignDraw">
                            <svg xmlns="http://www.w3.org/2000/svg" width="800px" height="800px" viewBox="0 0 24 24"
                                 fill="none">
                                <path d="M10.0303 8.96965C9.73741 8.67676 9.26253 8.67676 8.96964 8.96965C8.67675 9.26255 8.67675 9.73742 8.96964 10.0303L10.9393 12L8.96966 13.9697C8.67677 14.2625 8.67677 14.7374 8.96966 15.0303C9.26255 15.3232 9.73743 15.3232 10.0303 15.0303L12 13.0607L13.9696 15.0303C14.2625 15.3232 14.7374 15.3232 15.0303 15.0303C15.3232 14.7374 15.3232 14.2625 15.0303 13.9696L13.0606 12L15.0303 10.0303C15.3232 9.73744 15.3232 9.26257 15.0303 8.96968C14.7374 8.67678 14.2625 8.67678 13.9696 8.96968L12 10.9393L10.0303 8.96965Z"
                                      fill="#1C274C"/>
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                      d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
                                      fill="#1C274C"/>
                            </svg>
                        </div>
                        <canvas id="drawing-board" style="width: 100%"></canvas>
                        <div class="df aic jcc gap4">
                            <div id="createDoctorSign" class="doctorSignButton active" data-translate="createDoctorSign">
                                Cтворити підпис
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="waitingSignature" class="modalCustom">
        <div class="modalWrapper">
            <div class="modalContent">
                <div class="waitingSignatureQRIcon">
                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="80" height="80" rx="40" fill="white"/>
                        <path d="M40.0605 24.2002C41.6475 24.2002 43.0791 25.0459 43.8896 26.4629L56.9111 49.1445C57.3018 49.8145 57.5088 50.5742 57.5088 51.3379C57.5088 53.9648 55.6729 55.8008 53.0459 55.8008H27.0586C24.4316 55.8008 22.5977 53.9648 22.5977 51.3379C22.5996 50.5723 22.8057 49.8184 23.1963 49.1582L36.2139 26.4639C37.041 25.0459 38.4795 24.2002 40.0605 24.2002Z" fill="#DF1125"/>
                        <path d="M40.0537 47.0483C40.9639 47.0483 41.6768 47.7319 41.6768 48.605C41.6768 49.4624 40.9492 50.1616 40.0537 50.1616C39.1729 50.1616 38.4297 49.4487 38.4297 48.605C38.4297 47.7476 39.1582 47.0483 40.0537 47.0483ZM40.0361 33.3208C40.4325 33.3208 40.79 33.4615 41.041 33.7183C41.2725 33.9546 41.3965 34.2739 41.3896 34.6187L41.1523 43.519C41.1387 44.2729 40.7578 44.6733 40.0527 44.6733C39.3254 44.6732 38.9336 44.2729 38.9189 43.5171L38.6992 34.6021C38.6924 34.2486 38.8097 33.938 39.0371 33.7056C39.2812 33.4576 39.6359 33.3209 40.0361 33.3208Z" fill="white"/>
                    </svg>
                </div>
                <div class="waitingSignatureQRTitle" data-translate="waitingSignatureQRTitle">
                    Вам необхідно підтвердити дію.
                </div>
                <div class="waitingSignatureQRDescription" data-translate="waitingSignatureQRDescription">
                    Будь ласка, відскануйте QR-код нижче та виконайте всі кроки підтвердження в додатку COR ID
                </div>
                <div id="waitingSignatureQR">
                </div>
                <div class="waitingSignatureQRLoading" data-translate="waitingSignatureQRLoading">
                    Очікування...
                </div>
                <div id="waitingSignatureQRBtn" data-translate="waitingSignatureQRBtn">
                    Підписати примусово
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../../js/qrCodeGenerator.js"></script>
<script src="../../../COR_ID_Js/general_fun.js"></script>
<script src="../../js/canvasDraw.js"></script>
<script src="../../js/doctorSignModal.js"></script>
<script src="../../js/general.js"></script>
<script src="../../js/alert.js"></script>
<script src="../../js/websocket.js"></script>
<script>
    ws.onmessage = (ev) => {
        // Some servers send text frames; others may send JSON strings.
        try {
            const msg = JSON.parse(ev.data);

            if(msg?.event_type === "signature_status"){
                document.querySelector('#waitingSignature').classList.remove('open')
                showSuccessAlert('<span data-translate="signatureSuccess">Підписання пройшло успішно</span>')
                resetRecipesValue()
            }
            console.log(msg, "msg")
        } catch {
            // Non-JSON payloads
            console.warn('[ws] non-JSON message:', ev.data);
        }
    };

    const PATIENT_COR_ID = new URLSearchParams(window.location.search).get('userCorId')
    const waitingSignatureModal = document.querySelector('#waitingSignature');


    const drawItemInfoBLock = (title, value) => {
        if(!value){
            return null
        }

        const div = document.createElement('div');
        div.classList = "personalInfoBlock"
        div.innerHTML = (`
            <div class="personalInfoBlockKey">${title}:</div>
            <div class="personalInfoBlockValue">${value}</div>
        `)

        return div;
    }
    const drawGeneralInfoBLock = (title, items = []) => {
        const hasItem = items.some((item) => item !== null);

        if(!hasItem){
            return;
        }

        const div = document.createElement('div');
        div.classList = "df fdc"
        div.innerHTML = (`
            <div class="commentsWrapper df fdc" style="height: 100%; width: 256px;">
                <div class="commentsWrapperTop df aic jcc" style="height: 70.5px; width: 256px;">
                    ${title}
                </div>
                <div class="personalInfo custom-scroll" style="overflow-y: auto; overflow-x: hidden;">

                </div>
            </div>
        `)

        items.forEach( elem => {
            if(elem){
                div.querySelector('.personalInfo').append(elem)
            }
        })


        document.querySelector('#personalInfo').append(div)
    }

    const inputChange = () => {
        document.querySelectorAll('.recipesTopGroup.input').forEach(elem => {
            const minusButton = elem.querySelector('.recipesTopGroupImg.minus')
            const plusButton = elem.querySelector('.recipesTopGroupImg.plus')
            const input = elem.querySelector('input')

            plusButton.addEventListener('click', () => {
                const step = +input.getAttribute('step') || 1
                const maximum = +input.getAttribute('max')
                if(input.hasAttribute('max') && maximum === +input.value ){
                    return;
                }

                let newValue = +input.value + step;

                if(newValue.toString().split('.').length === 1){
                    newValue = `${newValue}.00`
                }

                input.value = newValue
            })
            minusButton.addEventListener('click', () => {
                const step = +input.getAttribute('step') || 1
                const minimum = +input.getAttribute('min')
                if(input.hasAttribute('min') && (minimum === +input.value) ){
                    return;
                }

                let newValue = +input.value - step;

                if(newValue.toString().split('.').length === 1){
                    newValue = `${newValue}.00`
                }

                input.value = newValue
            })
        })
    }

    const recipesPicker = () => {
        document.querySelectorAll('.recipesBottomPicker').forEach(elem => {
            elem.querySelectorAll('.recipesBottomPickerItem').forEach(elemItem => {
                elemItem.addEventListener('click', () => {
                    const pickerId = elem.getAttribute('data-id')
                    elem.querySelectorAll('.recipesBottomPickerItem').forEach(elemItem => elemItem.classList.remove('active'))
                    elemItem.classList.add('active')
                    document.querySelector(`input[name=${pickerId}]`).value = elemItem.getAttribute('data-id')
                })
            })
        })
    }
    const recipesSelectPicker = () => {
        document.querySelectorAll('.recipesTopPicker').forEach(elem => {
            elem.addEventListener('click', (e) => {
                if(document.querySelector('.recipesTopGroupSelect')){
                    document.querySelector('.recipesTopGroupSelect').remove()
                }

                const elem = e.currentTarget;

                if(elem.classList.contains('open')){
                    elem.classList.remove('open')
                    return;
                }
                document.querySelectorAll('.recipesTopPicker').forEach(elem => elem.classList.remove('open'))
                elem.classList.add('open')
                const pickerId = elem.getAttribute('data-id')
                const initialValue = document.querySelector(`input[name=${pickerId}]`).value;
                const {top, height, left} = elem.getBoundingClientRect()
                const div = document.createElement('div')
                div.classList.add("recipesTopGroupSelect")
                div.style.top = `${top + height + 10}px`
                div.style.left = `${left}px`
                div.innerHTML = (
                    `<div class="recipesTopGroupSelectItem ${initialValue === 'Up' ? 'active': ''}" data-id="Up">
                        Up
                    </div>
                    <div class="recipesTopGroupSelectItem ${initialValue === 'Down' ? 'active': ''}" data-id="Down">
                        Down
                    </div>
                    <div class="recipesTopGroupSelectItem ${initialValue === 'In' ? 'active': ''}" data-id="In">
                        In
                    </div>
                    <div class="recipesTopGroupSelectItem ${initialValue === 'Out' ? 'active': ''}" data-id="ç">
                        Out
                    </div>`
                );
                document.body.append(div);

                div.querySelectorAll('.recipesTopGroupSelectItem').forEach(elemItem => {
                    elemItem.addEventListener('click', () => {
                        div.querySelectorAll('.recipesTopGroupSelectItem').forEach(elemItem => elemItem.classList.remove('active'))
                        elemItem.classList.add('active')
                        document.querySelector(`input[name=${pickerId}]`).value = elemItem.getAttribute('data-id');
                        elem.querySelector('.recipesTopPickerName').innerText = elemItem.innerText
                        elem.classList.remove('open')
                        document.querySelector('.recipesTopGroupSelect').remove()
                    })
                })
            })
        })
        document.addEventListener('click', (e) => {
            const elem = e.target;
            if(elem.classList.contains('recipesTopPicker') || elem.closest('.recipesTopPicker') || elem.classList.contains('recipesTopGroupSelect') || elem.closest('.recipesTopGroupSelect')){
                return;
            }


            if(document.querySelector('.recipesTopGroupSelect')){
                document.querySelectorAll('.recipesTopPicker').forEach(elem => elem.classList.remove('open'))
                document.querySelector('.recipesTopGroupSelect').remove()
            }
        })
    }
    const signRecipesHandler = () => {
        const doctorSignButtonNODE = document.querySelector('.doctorSignButton');

        doctorSignButtonNODE.addEventListener('click', () => {
            signReport(async () => {
                const form = document.querySelector('form')
                const data = new FormData(form);
                const values = Object.fromEntries(data.entries());

                return fetch(`${API_BASE_URL}/api/ophthalmology/prescriptions/sign`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        ...values,
                        patient_id: PATIENT_COR_ID
                    })
                })
                    .then(res => res.json())
                    .then((report) => {
                        showSignProcessModal(report)
                    })
            })

        })
    }
    const showSignProcessModal = (report) => {
        if(report?.session_token && report.status === "pending"){
            waitingSignatureModal.querySelector('.modalContent').innerHTML = `
                        <div class="waitingSignatureQRIcon">
                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="80" height="80" rx="40" fill="white"/>
                                <path d="M40.0605 24.2002C41.6475 24.2002 43.0791 25.0459 43.8896 26.4629L56.9111 49.1445C57.3018 49.8145 57.5088 50.5742 57.5088 51.3379C57.5088 53.9648 55.6729 55.8008 53.0459 55.8008H27.0586C24.4316 55.8008 22.5977 53.9648 22.5977 51.3379C22.5996 50.5723 22.8057 49.8184 23.1963 49.1582L36.2139 26.4639C37.041 25.0459 38.4795 24.2002 40.0605 24.2002Z" fill="#DF1125"/>
                                <path d="M40.0537 47.0483C40.9639 47.0483 41.6768 47.7319 41.6768 48.605C41.6768 49.4624 40.9492 50.1616 40.0537 50.1616C39.1729 50.1616 38.4297 49.4487 38.4297 48.605C38.4297 47.7476 39.1582 47.0483 40.0537 47.0483ZM40.0361 33.3208C40.4325 33.3208 40.79 33.4615 41.041 33.7183C41.2725 33.9546 41.3965 34.2739 41.3896 34.6187L41.1523 43.519C41.1387 44.2729 40.7578 44.6733 40.0527 44.6733C39.3254 44.6732 38.9336 44.2729 38.9189 43.5171L38.6992 34.6021C38.6924 34.2486 38.8097 33.938 39.0371 33.7056C39.2812 33.4576 39.6359 33.3209 40.0361 33.3208Z" fill="white"/>
                            </svg>
                        </div>
                        <div class="waitingSignatureQRTitle" data-translate="waitingSignatureQRTitle">
                            You need to confirm the action.
                        </div>
                        <div class="waitingSignatureQRDescription" data-translate="waitingSignatureQRDescription">
                            Please scan the QR code below and follow all verification steps in the COR ID app.
                        </div>
                        <div id="waitingSignatureQR">
                        </div>
                        <div class="waitingSignatureQRLoading" data-translate="waitingSignatureQRLoading">
                            Expectation...
                        </div>
                        <div id="waitingSignatureQRBtn" data-translate="waitingSignatureQRBtn">
                            Sign forcibly
                        </div>
                        `
            document.querySelector("#doctorSign").classList.remove('open')

            if(report?.deep_link){
                new QRCode(waitingSignatureModal.querySelector('#waitingSignatureQR'), {
                    text: report.deep_link,
                    width: 200,
                    height: 200,
                    colorDark: '#291161',   // QR modules (the “dark” squares)
                    colorLight: '#ffffff',  // background (use 'transparent' if supported)
                });
            }
            waitingSignatureModal.classList.add('open')
            document.querySelector('#waitingSignatureQRBtn').addEventListener("click", () => {
                signReportImmediately(report.session_token)
            })
        }
    }
    const signReportImmediately = (sessionToken) => {
        if(checkToken()){
            console.log('EVERYTHING FINE')
            fetch(`${API_BASE_URL}/api/doctor/signing/confirm`, {
                method: "POST",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    session_token: sessionToken,
                    "status": "approved"
                })
            })
        }
    }
    const resetRecipesValue = () => {
        document.querySelectorAll('.recipesBottomPicker').forEach(elem => {
            elem.querySelectorAll('.recipesBottomPickerItem').forEach(elem => {
                elem.classList.remove('active');
            })
        })

        document.querySelector("input[name=od_sph]").value = '-20.00'
        document.querySelector("input[name=od_cyl]").value = '-6.00'
        document.querySelector("input[name=od_ax]").value = '0'
        document.querySelector("input[name=od_prism]").value = '0.00'
        document.querySelector("input[name=od_base]").value = ''
        document.querySelector("input[name=od_add]").value = '0.00'

        document.querySelector("input[name=os_sph]").value = '20.00'
        document.querySelector("input[name=os_cyl]").value = '6.00'
        document.querySelector("input[name=os_ax]").value = '0'
        document.querySelector("input[name=os_prism]").value = '0.00'
        document.querySelector("input[name=os_base]").value = ''
        document.querySelector("input[name=os_add]").value = '0.00'

        document.querySelector("textarea[name=note]").value = ''
        document.querySelector("input[name=term_months]").value = ''
        document.querySelector("input[name=issue_date]").value = ''

        document.querySelector(".recipesBottomPicker[data-id=glasses_purpose] .recipesBottomPickerItem:nth-child(1)").classList.add('active')
        document.querySelector("input[name=glasses_purpose]").value = 'glasses_for_reading'

        document.querySelector(".recipesBottomPicker[data-id=glasses_type] .recipesBottomPickerItem:nth-child(1)").classList.add('active')
        document.querySelector("input[name=glasses_type]").value = 'monofocal_glasses'
    }

    const getInfo = () => {
        fetch(`${API_BASE_URL}/api/doctor/patients/${PATIENT_COR_ID}`, {
            method: "GET",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
            },
        })
            .then(res => res.json())
            .then(userData => {
                const age = `${(userData.age || "")  ? `${userData.age}<span data-translate="yearsSuffix">р.</span>` : ''}`.trim();
                const gender = userData.sex === "F"? '<span data-translate="f">Жін</span>' : '<span data-translate="m">Чол</span>';
                const fullName = `${userData.surname || ""} ${userData.first_name || ""} ${userData.middle_name || ""}`.trim()
                const birthDay = `${(userData.birth_date || "")  ? new Date(userData.birth_date).toLocaleDateString() : ''}`.trim()
                document.querySelector('#userName').innerHTML = fullName;
                document.querySelector('#userGender').innerHTML = gender;
                document.querySelector('#userAge').innerHTML = age

                const lang = getSavedLang();
                const dict = translations?.[lang] || {};

                drawGeneralInfoBLock(dict.personalData || "Персональні дані", [
                    drawItemInfoBLock(dict.id || "COR-ID", PATIENT_COR_ID),
                    drawItemInfoBLock(dict.fullName_sh || "ПІБ", fullName),
                    drawItemInfoBLock(dict.birthDate || "Дата народження", `${birthDay} ${age}`),
                    drawItemInfoBLock(dict.gender || "Стать", gender),
                ]);

                drawGeneralInfoBLock(dict.physiologicalParams || "Фізіологічні параметри", [
                    drawItemInfoBLock(dict.height || "Зріст (см)", ""),
                    drawItemInfoBLock(dict.weight || "Вага (кг)", ""),
                    drawItemInfoBLock(dict.bloodPressure || "Тиск (SBP/DBP)", ""),
                    drawItemInfoBLock(dict.pulseParams || "Пульс (уд/хв)", ""),
                    drawItemInfoBLock(dict.sugar || "Цукор (ммоль/л)", ""),
                    drawItemInfoBLock(dict.saturation || "Сатурація (%)", ""),
                ]);

                drawGeneralInfoBLock(dict.contactInfo || "Контактна інформація", [
                    drawItemInfoBLock(dict.email || "Ел. пошта", ""),
                    drawItemInfoBLock(dict.phone || "Телефон", ""),
                    drawItemInfoBLock(dict.birthCity || "Місто народження", ""),
                    drawItemInfoBLock(dict.address || "Адреса проживання", ""),
                ])
            })
    }

    const switchSpecialist = () => {
        document.querySelectorAll('.specificMed .specificMedItem:not(.active)').forEach(elem => {
            elem.addEventListener('click', (e) => {
                const attr = elem.getAttribute('data-id')
                if(attr){
                    if(attr === "ophthalmology"){
                        window.location.href = `/static/COR_LAB/medical-card/ophthalmology/recipes.html?userCorId=${PATIENT_COR_ID}`
                    }
                    if(attr === "pathomorphology"){
                        window.location.href = `/static/COR_LAB/medical-card/pathomorphology/research.html?userCorId=${PATIENT_COR_ID}`
                    }
                }
            })
        })
    }
    const switchRole = () => {
        document.querySelector('.role-toggle .role-btn:not(.active)').addEventListener('click', (e) => {
            window.location.href = `/static/COR_LAB/lab.html?userCorId=${PATIENT_COR_ID}`
        })
    }
    const goToTab = () => {
        document.querySelectorAll(".tabs .tab:not(.active)").forEach(elem => {
            elem.addEventListener('click', e => {
                const element = e.currentTarget;
                let queryString = []

                if (PATIENT_COR_ID) {
                    queryString.push(`userCorId=${PATIENT_COR_ID}`)
                }

                if (element.classList.contains('medCardPage')) {
                    window.location.href = `/static/COR_LAB/medical-card/pathomorphology/research.html?${queryString.join('&')}`
                }
                if (element.classList.contains('directionPage')) {
                    window.location.href = `/static/COR_LAB/direction.html?${queryString.join('&')}`
                }
                if (element.classList.contains('tenderloinPage')) {
                    window.location.href = `/static/COR_LAB/tenderloin.html?${queryString.join('&')}`
                }
                if (element.classList.contains('glassPage')) {
                    window.location.href = `/static/COR_LAB/glass.html?${queryString.join('&')}`
                }
                if (element.classList.contains('conclusionPage')) {
                    window.location.href = `/static/COR_LAB/conclusion.html?${queryString.join('&')}`
                }
                if (element.classList.contains('explorationPage')) {
                    window.location.href = `/static/COR_LAB/exploration.html?${queryString.join('&')}`
                }
            })
        })
    }
    const goToCasesHandler = () => {
        document.querySelector('#goToCases')?.addEventListener('click', () => {
            window.location.href = `/static/COR_LAB/doctor_patients_page.html`
        })
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        goToCasesHandler()
        signRecipesHandler()
        goToTab()
        switchRole()
        switchSpecialist()
        inputChange()
        recipesPicker()
        recipesSelectPicker()
        getInfo()
    });
</script>
</body>
</html>
