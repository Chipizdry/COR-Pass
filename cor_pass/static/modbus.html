<body>
  <h1>üîã –£—Ä–æ–≤–µ–Ω—å –∑–∞—Ä—è–¥–∞ –±–∞—Ç–∞—Ä–µ–∏</h1>

  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
  <div id="status-section">
    <p id="soc">SoC: ...</p>
    <p id="volt">–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ...</p>
    <p id="curr">–¢–æ–∫: ...</p>
    <p id="power">–ú–æ—â–Ω–æ—Å—Ç—å: ...</p>
    <p id="inverter_power">–ú–æ—â–Ω–æ—Å—Ç—å –∏–Ω–≤–µ—Ä—Ç–æ—Ä–∞: ...</p>
    <p id="soh">SOH: ...</p>

    <div id="ess_indicator">
      <h3>‚öôÔ∏è –°—Ç–∞—Ç—É—Å ESS</h3>
      <p>–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: <span id="mode_display">...</span></p>
      <p>–ó–∞–ø—Ä–µ—Ç –∑–∞—Ä—è–¥–∞: <span id="disable_charge_status">...</span></p>
      <p>–ó–∞–ø—Ä–µ—Ç –æ—Ç–¥–∞—á–∏: <span id="disable_feed_status">...</span></p>
      <p>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è —Ç—Ä–µ–≤–æ–≥–∞: <span id="temp_alarm">...</span></p>
      <p>–¢—Ä–µ–≤–æ–≥–∞ –Ω–∏–∑–∫–æ–≥–æ –∑–∞—Ä—è–¥–∞: <span id="low_batt_alarm">...</span></p>
      <p>–¢—Ä–µ–≤–æ–≥–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏: <span id="overload_alarm">...</span></p>
      <p>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ L1: <span id="ess_power_l1">...</span> W</p>
      <p>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ L2: <span id="ess_power_l2">...</span> W</p>
      <p>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ L3: <span id="ess_power_l3">...</span> W</p>
      <p>–ü–æ—Ç–µ—Ä—è —Å–µ—Ç–∏: <span id="grid_lost">...</span></p>
      <p>–ó–∞–ø—Ä–µ—Ç —Ñ–∏–¥-–∏–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–∏: <span id="do_not_feed">...</span></p>
      <p>–ú–∞–∫—Å. —Ñ–∏–¥-–∏–Ω –º–æ—â–Ω–æ—Å—Ç—å L1: <span id="max_feed_l1">...</span> –í—Ç</p>
      <p>–ú–∞–∫—Å. —Ñ–∏–¥-–∏–Ω –º–æ—â–Ω–æ—Å—Ç—å L2: <span id="max_feed_l2">...</span> –í—Ç</p>
      <p>–ú–∞–∫—Å. —Ñ–∏–¥-–∏–Ω –º–æ—â–Ω–æ—Å—Ç—å L3: <span id="max_feed_l3">...</span> –í—Ç</p>
      <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å setpoint –∫–∞–∫ –ª–∏–º–∏—Ç: <span id="setpoints_as_limit">...</span></p>
      <p>–†–µ–∂–∏–º –æ—Ñ—Ñ—Å–µ—Ç–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è: <span id="ov_offset_mode">...</span></p>
      <p>–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞—Ç—å –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: <span id="prefer_renewable">...</span></p>
    </div>
  </div>

  <hr>

  <!-- –û—Ä–≥–∞–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div id="control-section">
    <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESS</h3>
    <div class="control-group">
      <button onclick="forceDischargeToGrid()" style="padding:10px; background:#ffdddd; border:1px solid #aa0000; border-radius:5px; font-weight:bold; cursor:pointer;">
        üîã –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –≤ —Å–µ—Ç—å
      </button>
    </div>
    <div class="control-group">
      <label>
        üîå –ó–∞–ø—Ä–µ—Ç –∑–∞—Ä—è–¥–∞:
        <input type="checkbox" id="disable_charge" onchange="toggleFlag('disable_charge', this.checked)">
      </label>
    </div>

    <div class="control-group">
      <label>
        üîÅ –ó–∞–ø—Ä–µ—Ç –æ—Ç–¥–∞—á–∏:
        <input type="checkbox" id="disable_feed_in" onchange="toggleFlag('disable_feed', this.checked)">
      </label>
    </div>

    <div class="control-group">
      <p>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</p>
      <label><input type="radio" name="mode" value="1" onchange="setMode(this)"> Charger Only</label><br>
      <label><input type="radio" name="mode" value="2" onchange="setMode(this)"> Inverter Only</label><br>
      <label><input type="radio" name="mode" value="3" onchange="setMode(this)"> On</label><br>
      <label><input type="radio" name="mode" value="4" onchange="setMode(this)"> Off</label>
    </div>

    <div class="control-group">
      <h4>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ ESS</h4>
      <label>
        –§–∞–∑–∞ L1 (–í—Ç):
        <input type="number" id="ess_power_l1_input" onchange="setEssPower('ess_power_setpoint_l1', this.value)">
      </label><br>
      <label>
        –§–∞–∑–∞ L2 (–í—Ç):
        <input type="number" id="ess_power_l2_input" onchange="setEssPower('ess_power_setpoint_l2', this.value)">
      </label><br>
      <label>
        –§–∞–∑–∞ L3 (–í—Ç):
        <input type="number" id="ess_power_l3_input" onchange="setEssPower('ess_power_setpoint_l3', this.value)">
      </label><br><br>
      <label>
        Max Feed-in L1:
        <input type="number" onchange="setFeedLimit('max_feed_in_l1', this.value)">
      </label><br>
      <label>
        Max Feed-in L2:
        <input type="number" onchange="setFeedLimit('max_feed_in_l2', this.value)">
      </label><br>
      <label>
        Max Feed-in L3:
        <input type="number" onchange="setFeedLimit('max_feed_in_l3', this.value)">
      </label>
    </div>
  </div>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #status-section, #control-section {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .control-group {
      margin-bottom: 15px;
      padding: 10px;
      background: #e9e9e9;
      border-radius: 5px;
    }
    h3, h4 {
      margin-top: 0;
    }
  </style>

  <script>
    const modeNames = {
      1: "Charger Only",
      2: "Inverter Only",
      3: "On",
      4: "Off"
    };

    const alarmStatus = {
      0: "–ù–æ—Ä–º–∞",
      1: "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ",
      2: "–¢—Ä–µ–≤–æ–≥–∞"
    };



    let tick = 0;
    async function fetchStatus() {
      try {
        const res = await fetch('/api/modbus/battery_status');
        const data = await res.json();
        document.getElementById('soc').innerText = `üîã SoC: ${data.soc}%`;
        document.getElementById('volt').innerText = `üîå –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ${data.voltage} –í`;
        document.getElementById('curr').innerText = `‚ö° –¢–æ–∫: ${data.current} –ê`;
        document.getElementById('power').innerText = `üí° –ú–æ—â–Ω–æ—Å—Ç—å: ${data.power} –í—Ç`;
        document.getElementById('soh').innerText = `‚ù§Ô∏è SOH: ${data.soh}%`;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –±–∞—Ç–∞—Ä–µ–∏:", err);
      }
    }

    async function fetchInverter() {
      try {
        const res = await fetch('/api/modbus/inverter_power');
        const data = await res.json();
        document.getElementById('inverter_power').innerText = `‚öôÔ∏è –ú–æ—â–Ω–æ—Å—Ç—å –∏–Ω–≤–µ—Ä—Ç–æ—Ä–∞: ${data.inverter_power} –í—Ç`;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–æ—â–Ω–æ—Å—Ç–∏ –∏–Ω–≤–µ—Ä—Ç–æ—Ä–∞:", err);
      }
    }

    async function fetchEss() {
  try {
    const res = await fetch('/api/modbus/ess_status');
    const data = await res.json();

    const mode = data.mode || {};
    const flags = data.flags || {};
    const power = data.power || {};
    const alarms = data.alarms || {};

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    document.getElementById('mode_display').innerText = modeNames[mode.switch_position] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    document.getElementById('disable_charge_status').innerText = flags.disable_charge ? "–í–ö–õ" : "–í–´–ö–õ";
    document.getElementById('disable_feed_status').innerText = flags.disable_feed ? "–í–ö–õ" : "–í–´–ö–õ";

    document.getElementById('temp_alarm').innerText = alarmStatus[alarms.temperature_alarm] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    document.getElementById('low_batt_alarm').innerText = alarmStatus[alarms.low_battery_alarm] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    document.getElementById('overload_alarm').innerText = alarmStatus[alarms.overload_alarm] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";

    document.getElementById('ess_power_l1').innerText = power.ess_power_setpoint_l1 ?? "...";
    document.getElementById('ess_power_l2').innerText = power.ess_power_setpoint_l2 ?? "...";
    document.getElementById('ess_power_l3').innerText = power.ess_power_setpoint_l3 ?? "...";

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç)
    if (!document.activeElement.closest('#control-section')) {
      document.getElementById('disable_charge').checked = flags.disable_charge === 1 || flags.disable_charge === true;
      document.getElementById('disable_feed_in').checked = flags.disable_feed === 1 || flags.disable_feed === true;

      const radios = document.getElementsByName('mode');
      for (const radio of radios) {
        radio.checked = parseInt(radio.value) === mode.switch_position;
      }

      document.getElementById('ess_power_l1_input').value = power.ess_power_setpoint_l1 ?? "";
      document.getElementById('ess_power_l2_input').value = power.ess_power_setpoint_l2 ?? "";
      document.getElementById('ess_power_l3_input').value = power.ess_power_setpoint_l3 ?? "";

      document.getElementById('grid_lost').innerText =
        alarmStatus[alarms.grid_lost] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";

      document.getElementById('do_not_feed').innerText =
        flags.do_not_feed_in_ov ? "–î–ê" : "–ù–ï–¢";

      document.getElementById('max_feed_l1').innerText = power.max_feed_in_l1 ?? "...";
      document.getElementById('max_feed_l2').innerText = power.max_feed_in_l2 ?? "...";
      document.getElementById('max_feed_l3').innerText = power.max_feed_in_l3 ?? "...";

      document.getElementById('setpoints_as_limit').innerText =
        flags.setpoints_as_limit ? "–î–ê" : "–ù–ï–¢";

      document.getElementById('ov_offset_mode').innerText =
        flags.ov_offset_mode === 1 ? "0.1 –í" : "1 –í";

      document.getElementById('prefer_renewable').innerText =
        flags.prefer_renewable ? "–î–ê" : "–ù–ï–¢";
          }

  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ ESS —Å—Ç–∞—Ç—É—Å–∞:", err);
  }
}
async function toggleFlag(flagName, value) {
      try {
        const payload = {};
        payload[flagName] = value;
        await fetch('/api/modbus/ess_status/flags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–ª–∞–≥–∞ ${flagName}:`, err);
      }
    }

    async function setEssPower(name, value) {
      const numericValue = parseInt(value);
      if (isNaN(numericValue)) {
        console.error('–û—à–∏–±–∫–∞: –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º', value);
        return;
      }
      try {
        const payload = {};
        payload[name] = numericValue;
        await fetch('/api/modbus/ess_status/power', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ—â–Ω–æ—Å—Ç–∏:', err);
      }
    }

    async function setFeedLimit(name, value) {
      const numericValue = parseInt(value);
      if (isNaN(numericValue)) {
        console.error('–û—à–∏–±–∫–∞: –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º', value);
        return;
      }
      try {
        const payload = {};
        payload[name] = numericValue;
        await fetch('/api/modbus/ess_status/feedin_limits', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∏–º–∏—Ç–∞ —Ñ–∏–¥-–∏–Ω:', err);
      }
    }

    async function setMode(radio) {
      try {
        await fetch('/api/modbus/ess_status/mode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ switch_position: parseInt(radio.value) })
        });
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∂–∏–º–∞:", err);
      }
    }


    async function forceDischarge() {
  const power = {
    ess_power_setpoint_l1: -100,
    ess_power_setpoint_l2: -100,
    ess_power_setpoint_l3: -100
  };

  try {
    await fetch('/api/modbus/ess_status/power', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(power)
    });
    console.log("‚ö° –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞:", err);
  }
}
async function forceDischargeToGrid() {
  try {
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–æ–≤: —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ñ–∏–¥-–∏–Ω + –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å setpoints –∫–∞–∫ –ª–∏–º–∏—Ç—ã
    await fetch('/api/modbus/ess_status/flags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        disable_feed: false,
        setpoints_as_limit: true
      })
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –º–æ—â–Ω–æ—Å—Ç–µ–π –Ω–∞ –≤—Å–µ—Ö —Ñ–∞–∑–∞—Ö
    await fetch('/api/modbus/ess_status/power', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ess_power_setpoint_l1: -1000,
        ess_power_setpoint_l2: -1000,
        ess_power_setpoint_l3: -1000
      })
    });

    // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: On
    await fetch('/api/modbus/ess_status/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        switch_position: 3
      })
    });

    // –õ–∏–º–∏—Ç—ã —Ñ–∏–¥-–∏–Ω–∞: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ
    await fetch('/api/modbus/ess_status/feedin_limits', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        max_feed_in_l1: 10000,
        max_feed_in_l2: 10000,
        max_feed_in_l3: 10000
      })
    });

    console.log("‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞:", err);
  }
}

    function safeInt(id) {
  const val = parseInt(document.getElementById(id).value);
  return isNaN(val) ? undefined : val;
}
function safeIntByQuery(selector) {
  const val = parseInt(document.querySelector(selector).value);
  return isNaN(val) ? undefined : val;
}

    function collectEssControlState() {
  return {
    flags: {
      disable_charge: document.getElementById('disable_charge').checked,
      disable_feed: document.getElementById('disable_feed_in').checked,
    },
    power: {
      ess_power_setpoint_l1: safeInt('ess_power_l1_input'),
      ess_power_setpoint_l2: safeInt('ess_power_l2_input'),
      ess_power_setpoint_l3: safeInt('ess_power_l3_input'),
    },
    feedin_limits: {
      max_feed_in_l1: safeIntByQuery('[onchange*="max_feed_in_l1"]'),
      max_feed_in_l2: safeIntByQuery('[onchange*="max_feed_in_l2"]'),
      max_feed_in_l3: safeIntByQuery('[onchange*="max_feed_in_l3"]'),
    },
    mode: {
      switch_position: parseInt(document.querySelector('input[name="mode"]:checked')?.value)
    }
  };
}



async function syncEssControlState() {
  const state = collectEssControlState();

  try {
    await Promise.all([
      fetch('/api/modbus/ess_status/flags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(state.flags)
      }),
      fetch('/api/modbus/ess_status/feedin_limits', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(state.feedin_limits)
      }),
      fetch('/api/modbus/ess_status/mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(state.mode)
      })
    ]);
    console.log("‚úÖ ESS —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ESS —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:", err);
  }
}

  // –û–±–Ω–æ–≤–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  setInterval(() => {
    tick++;
    
    if (tick % 2 === 0) fetchStatus();
    if (tick % 3 === 0) fetchInverter();
    if (tick % 4 === 0) fetchEss();
    if (tick % 5 === 0) syncEssControlState();
    if (tick % 6 === 0)fetchInverterPowerStatus();
    if (tick >= 60) tick = 0;
  }, 500);

    // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    fetchStatus();
    fetchInverter();
    fetchEss();
    fetchInverterPowerStatus();
   
  </script>
</body>