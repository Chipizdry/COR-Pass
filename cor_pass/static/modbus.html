<body>
  <h1>üîã –£—Ä–æ–≤–µ–Ω—å –∑–∞—Ä—è–¥–∞ –±–∞—Ç–∞—Ä–µ–∏</h1>

  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
  <div id="status-section">
    <p id="soc">SoC: ...</p>
    <p id="volt">–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ...</p>
    <p id="curr">–¢–æ–∫: ...</p>
    <p id="power">–ú–æ—â–Ω–æ—Å—Ç—å: ...</p>
    <p id="inverter_power">–ú–æ—â–Ω–æ—Å—Ç—å –∏–Ω–≤–µ—Ä—Ç–æ—Ä–∞: ...</p>
    <p id="soh">SOH: ...</p>

    <div id="ess_indicator">
      <h3>‚öôÔ∏è –°—Ç–∞—Ç—É—Å ESS</h3>
      <p>–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: <span id="mode_display">...</span></p>
      <p>–ó–∞–ø—Ä–µ—Ç –∑–∞—Ä—è–¥–∞: <span id="disable_charge_status">...</span></p>
      <p>–ó–∞–ø—Ä–µ—Ç –æ—Ç–¥–∞—á–∏: <span id="disable_feed_status">...</span></p>
      <p>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è —Ç—Ä–µ–≤–æ–≥–∞: <span id="temp_alarm">...</span></p>
      <p>–¢—Ä–µ–≤–æ–≥–∞ –Ω–∏–∑–∫–æ–≥–æ –∑–∞—Ä—è–¥–∞: <span id="low_batt_alarm">...</span></p>
      <p>–¢—Ä–µ–≤–æ–≥–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏: <span id="overload_alarm">...</span></p>
      <p>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ L1: <span id="ess_power_l1">...</span> W</p>
      <p>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ L2: <span id="ess_power_l2">...</span> W</p>
      <p>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ L3: <span id="ess_power_l3">...</span> W</p>
    </div>
  </div>

  <hr>

  <!-- –û—Ä–≥–∞–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div id="control-section">
    <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESS</h3>
    
    <div class="control-group">
      <label>
        üîå –ó–∞–ø—Ä–µ—Ç –∑–∞—Ä—è–¥–∞:
        <input type="checkbox" id="disable_charge" onchange="toggleEss('disable_charge', this.checked)">
      </label>
    </div>

    <div class="control-group">
      <label>
        üîÅ –ó–∞–ø—Ä–µ—Ç –æ—Ç–¥–∞—á–∏:
        <input type="checkbox" id="disable_feed_in" onchange="toggleEss('disable_feed', this.checked)">
      </label>
    </div>

    <div class="control-group">
      <p>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</p>
      <label><input type="radio" name="mode" value="1" onchange="setMode(this)"> Charger Only</label><br>
      <label><input type="radio" name="mode" value="2" onchange="setMode(this)"> Inverter Only</label><br>
      <label><input type="radio" name="mode" value="3" onchange="setMode(this)"> On</label><br>
      <label><input type="radio" name="mode" value="4" onchange="setMode(this)"> Off</label>
    </div>

    <div class="control-group">
      <h4>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ ESS</h4>
      <label>
        –§–∞–∑–∞ L1 (–í—Ç):
        <input type="number" id="ess_power_l1_input" onchange="setEssPower('ess_power_setpoint_l1', this.value)">
      </label><br>
      <label>
        –§–∞–∑–∞ L2 (–í—Ç):
        <input type="number" id="ess_power_l2_input" onchange="setEssPower('ess_power_setpoint_l2', this.value)">
      </label><br>
      <label>
        –§–∞–∑–∞ L3 (–í—Ç):
        <input type="number" id="ess_power_l3_input" onchange="setEssPower('ess_power_setpoint_l3', this.value)">
      </label>
    </div>
  </div>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #status-section, #control-section {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .control-group {
      margin-bottom: 15px;
      padding: 10px;
      background: #e9e9e9;
      border-radius: 5px;
    }
    h3, h4 {
      margin-top: 0;
    }
  </style>

  <script>
    const modeNames = {
      1: "Charger Only",
      2: "Inverter Only",
      3: "On",
      4: "Off"
    };

    const alarmStatus = {
      0: "–ù–æ—Ä–º–∞",
      1: "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ",
      2: "–¢—Ä–µ–≤–æ–≥–∞"
    };

    let tick = 0;
    async function fetchStatus() {
      try {
        const res = await fetch('/api/modbus/battery_status');
        const data = await res.json();
        document.getElementById('soc').innerText = `üîã SoC: ${data.soc}%`;
        document.getElementById('volt').innerText = `üîå –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ${data.voltage} –í`;
        document.getElementById('curr').innerText = `‚ö° –¢–æ–∫: ${data.current} –ê`;
        document.getElementById('power').innerText = `üí° –ú–æ—â–Ω–æ—Å—Ç—å: ${data.power} –í—Ç`;
        document.getElementById('soh').innerText = `‚ù§Ô∏è SOH: ${data.soh}%`;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –±–∞—Ç–∞—Ä–µ–∏:", err);
      }
    }

    async function fetchInverter() {
      try {
        const res = await fetch('/api/modbus/inverter_power');
        const data = await res.json();
        document.getElementById('inverter_power').innerText = `‚öôÔ∏è –ú–æ—â–Ω–æ—Å—Ç—å –∏–Ω–≤–µ—Ä—Ç–æ—Ä–∞: ${data.inverter_power} –í—Ç`;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–æ—â–Ω–æ—Å—Ç–∏ –∏–Ω–≤–µ—Ä—Ç–æ—Ä–∞:", err);
      }
    }

    async function fetchEss() {
      try {
        const res = await fetch('/api/modbus/ess_status');
        const data = await res.json();

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        document.getElementById('disable_charge_status').innerText = data.disable_charge ? "–í–ö–õ" : "–í–´–ö–õ";
        document.getElementById('disable_feed_status').innerText = data.disable_feed ? "–í–ö–õ" : "–í–´–ö–õ";
        document.getElementById('mode_display').innerText = modeNames[data.switch_position] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        document.getElementById('temp_alarm').innerText = alarmStatus[data.temperature_alarm] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        document.getElementById('low_batt_alarm').innerText = alarmStatus[data.low_battery_alarm] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        document.getElementById('overload_alarm').innerText = alarmStatus[data.overload_alarm] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        document.getElementById('ess_power_l1').innerText = data.ess_power_setpoint_l1;
        document.getElementById('ess_power_l2').innerText = data.ess_power_setpoint_l2;
        document.getElementById('ess_power_l3').innerText = data.ess_power_setpoint_l3;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç)
        if (!document.activeElement.closest('#control-section')) {
          document.getElementById('disable_charge').checked = data.disable_charge === 1;
          document.getElementById('disable_feed_in').checked = data.disable_feed === 1;

          const radios = document.getElementsByName('mode');
          for (const radio of radios) {
            radio.checked = parseInt(radio.value) === data.switch_position;
          }

          document.getElementById('ess_power_l1_input').value = data.ess_power_setpoint_l1;
          document.getElementById('ess_power_l2_input').value = data.ess_power_setpoint_l2;
          document.getElementById('ess_power_l3_input').value = data.ess_power_setpoint_l3;
        }

      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ ESS —Å—Ç–∞—Ç—É—Å–∞:", err);
      }
    }

    async function toggleEss(name, value) {
  try {
    const payload = {
      disable_charge: name === 'disable_charge' ? value : document.getElementById('disable_charge').checked,
      disable_feed: name === 'disable_feed' ? value : document.getElementById('disable_feed_in').checked
    };
    
    await fetch('/api/modbus/ess_status/flags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (err) {
    console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–ª–∞–≥–æ–≤ ESS:`, err);
  }
}

async function setMode(radio) {
  try {
    await fetch('/api/modbus/ess_status/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ switch_position: parseInt(radio.value) })
    });
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–∂–∏–º–∞:", err);
  }
}

async function setEssPower(name, value) {
  const numericValue = parseInt(value);
  if (isNaN(numericValue)) {
    console.error('–û—à–∏–±–∫–∞: –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º', value);
    return;
  }

  try {
    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ —Å –∏–∑–º–µ–Ω—è–µ–º—ã–º –ø–æ–ª–µ–º
    const payload = {};
    payload[name] = numericValue;
    
    await fetch('/api/modbus/ess_status/power', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ—â–Ω–æ—Å—Ç–∏:', err);
  }
}

    // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    fetchStatus();
    fetchInverter();
    fetchEss();

    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    setInterval(() => {
      tick++;

      if (tick % 2 === 0) {
        fetchStatus();
      }

      if (tick % 3 === 0) {
        fetchInverter();
      }

      if (tick % 5 === 0) {
        fetchEss();
      }

      // –°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–ª—Å—è
      if (tick >= 60) {
        tick = 0;
      }
    }, 500);
  </script>
</body>