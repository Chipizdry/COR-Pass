<body>
  <h1>๐ ะฃัะพะฒะตะฝั ะทะฐััะดะฐ ะฑะฐัะฐัะตะธ</h1>

  <!-- ะะฝะดะธะบะฐัะพัั -->
  <div id="status-section">
    <p id="soc">SoC: ...</p>
    <p id="volt">ะะฐะฟััะถะตะฝะธะต: ...</p>
    <p id="curr">ะขะพะบ: ...</p>
    <p id="power">ะะพัะฝะพััั: ...</p>
    <p id="inverter_power">ะะพัะฝะพััั 2: ...</p>
    <p id="soh">SOH: ...</p>

    <p id="ess_indicator">
      โ๏ธ ะขะตะบััะธะน ัะตะถะธะผ ัะฐะฑะพัั: <span id="mode_display">...</span><br>
      ๐ ะะฐะฟัะตั ะทะฐััะดะฐ: <span id="disable_charge_status">...</span><br>
      ๐ ะะฐะฟัะตั ะพัะดะฐัะธ: <span id="disable_feed_status">...</span>
    </p>
  </div>

  <hr>

  <!-- ะัะณะฐะฝั ัะฟัะฐะฒะปะตะฝะธั -->
  <div id="control-section">
    <label>
      ๐ ะะฐะฟัะตั ะทะฐััะดะฐ:
      <input type="checkbox" id="disable_charge" onchange="toggleEss('disable_charge', this.checked)">
    </label><br>

    <label>
      ๐ ะะฐะฟัะตั ะพัะดะฐัะธ:
      <input type="checkbox" id="disable_feed_in" onchange="toggleEss('disable_feed_in', this.checked)">
    </label><br>

    <p>โ๏ธ ะฃััะฐะฝะพะฒะธัั ัะตะถะธะผ ัะฐะฑะพัั:</p>
    <label><input type="radio" name="mode" value="1" onchange="setMode(this)"> Charger Only</label><br>
    <label><input type="radio" name="mode" value="2" onchange="setMode(this)"> Inverter Only</label><br>
    <label><input type="radio" name="mode" value="3" onchange="setMode(this)"> On</label><br>
    <label><input type="radio" name="mode" value="4" onchange="setMode(this)"> Off</label>
  </div>

  <script>
    const modeNames = {
      1: "Charger Only",
      2: "Inverter Only",
      3: "On",
      4: "Off"
    };

    let tick = 0;
    async function fetchStatus() {
      try {
        const res = await fetch('/api/modbus/battery_status');
        const data = await res.json();
        document.getElementById('soc').innerText = `๐ SoC: ${data.soc}%`;
        document.getElementById('volt').innerText = `๐ ะะฐะฟััะถะตะฝะธะต: ${data.voltage} ะ`;
        document.getElementById('curr').innerText = `โก ะขะพะบ: ${data.current} ะ`;
        document.getElementById('power').innerText = `๐ก ะะพัะฝะพััั: ${data.power} ะั`;
        document.getElementById('soh').innerText = `โค๏ธ SOH: ${data.soh}%`;
      } catch (err) {
        console.error("ะัะธะฑะบะฐ ะฟัะธ ะฟะพะปััะตะฝะธะธ ะดะฐะฝะฝัั ะฑะฐัะฐัะตะธ:", err);
      }
    }

    async function fetchInverter() {
      try {
        const res = await fetch('/api/modbus/inverter_power');
        const data = await res.json();
        document.getElementById('inverter_power').innerText = `โ๏ธ ะะพัะฝะพััั ะธะฝะฒะตััะพัะฐ: ${data.inverter_power} ะั`;
      } catch (err) {
        console.error("ะัะธะฑะบะฐ ะฟัะธ ะฟะพะปััะตะฝะธะธ ะผะพัะฝะพััะธ ะธะฝะฒะตััะพัะฐ:", err);
      }
    }

    async function fetchEss() {
      try {
        const res = await fetch('/api/modbus/ess_status');
        const data = await res.json();

        // ะะฑะฝะพะฒะปัะตะผ ะธะฝะดะธะบะฐัะพัั
        document.getElementById('disable_charge_status').innerText = data.disable_charge ? "ะะะ" : "ะะซะะ";
        document.getElementById('disable_feed_status').innerText = data.disable_feed_in ? "ะะะ" : "ะะซะะ";
        document.getElementById('mode_display').innerText = modeNames[data.switch_position] || "ะะตะธะทะฒะตััะฝะพ";

        // ะะฑะฝะพะฒะปัะตะผ ะบะพะฝััะพะปั (ัะพะปัะบะพ ะตัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฒะทะฐะธะผะพะดะตะนััะฒัะตั)
        if (!document.activeElement.closest('#control-section')) {
          document.getElementById('disable_charge').checked = data.disable_charge === 1;
          document.getElementById('disable_feed_in').checked = data.disable_feed_in === 1;

          const radios = document.getElementsByName('mode');
          for (const radio of radios) {
            radio.checked = parseInt(radio.value) === data.switch_position;
          }
        }

      } catch (err) {
        console.error("ะัะธะฑะบะฐ ะฟัะธ ะฟะพะปััะตะฝะธะธ ESS ััะฐัััะฐ:", err);
      }
    }

    async function toggleEss(name, value) {
      const payload = {};
      payload[name] = value;
      try {
        await fetch('/api/modbus/ess_status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error(`ะัะธะฑะบะฐ ะพัะฟัะฐะฒะบะธ ะฟะฐัะฐะผะตััะฐ ${name}:`, err);
      }
    }

    async function setMode(radio) {
      try {
        await fetch('/api/modbus/ess_status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ switch_position: parseInt(radio.value) })
        });
      } catch (err) {
        console.error("ะัะธะฑะบะฐ ัััะฐะฝะพะฒะบะธ ัะตะถะธะผะฐ:", err);
      }
    }

    // ะะตัะฒะฐั ะทะฐะณััะทะบะฐ
  //  fetchStatus();
  //  fetchInverter();
  //  fetchEss();

    // ะะตัะธะพะดะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต
    setInterval(() => {
    tick++;

    if (tick % 2 === 0) {
        fetchStatus();
    }

    if (tick % 3 === 0) {
        fetchInverter();
    }

    if (tick % 5 === 0) {
        fetchEss();
    }

    // ะกะฑัะพัะธัั ััะตััะธะบ, ััะพะฑั ะฝะต ะฟะตัะตะฟะพะปะฝัะปัั
    if (tick >= 60) {
        tick = 0;
    }

}, 2000);
  </script>
</body>
