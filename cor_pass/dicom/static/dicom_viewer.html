<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DICOM Viewer</title>
  <style>
    .viewer { display: flex; gap: 40px; } /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ */
    .view { display: flex; flex-direction: column; align-items: center; }
    img { border: 1px solid #444; width: 512px; height: 512px; } /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    input[type="range"] { width: 500px; } /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –ø–æ–ª–∑—É–Ω–∫–æ–≤ */
  </style>
</head>
<body>
  
 <!-- <div class="viewer">
    <div class="view">
      <label>Axial <input type="range" id="axial" min="0" max="500" value="50" onchange="update('axial')"></label>
      <img id="img-axial">
    </div>
    <div class="view">
      <label>Sagittal <input type="range" id="sagittal" min="0" max="500" value="100" onchange="update('sagittal')"></label>
      <img id="img-sagittal">
    </div>
    <div class="view">
      <label>Coronal <input type="range" id="coronal" min="0" max="500" value="100" step="1" onchange="update('coronal')"></label>
      <img id="img-coronal">
    </div>
  </div> -->

  <div class="viewer">
    <div class="view">
        <label>Axial <input type="range" id="axial" min="0" max="500" value="50" onchange="update('axial')"></label>
        
        <canvas id="canvas-axial" width="512" height="512"></canvas>
    </div>
    <div class="view">
        <label>Sagittal <input type="range" id="sagittal" min="0" max="500" value="100" onchange="update('sagittal')"></label>
    
        <canvas id="canvas-sagittal" width="512" height="512"></canvas>
    </div>
    <div class="view">
        <label>Coronal <input type="range" id="coronal" min="0" max="500" value="100" onchange="update('coronal')"></label>
      
        <canvas id="canvas-coronal" width="512" height="512"></canvas>
    </div>
</div>

  <script>
    async function update(plane) {
      const idx = document.getElementById(plane).value;
      const img = document.getElementById('img-' + plane);
      img.src = `/api/dicom/reconstruct/${plane}?index=${idx}&t=${Date.now()}`;
    }

    ['axial', 'sagittal', 'coronal'].forEach(update);
  </script>
   <script>
   let currentPlane = 'axial';
   let markers = { axial: [], sagittal: [], coronal: [] }; // –•—Ä–∞–Ω–∏–º –º–µ—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑—Ä–µ–∑–∞
   
   // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   async function update(plane) {
     currentPlane = plane;
     const idx = document.getElementById(plane).value;
     const canvas = document.getElementById('canvas-' + plane);
     const ctx = canvas.getContext('2d');
     const img = new Image();
     img.onload = function () {
       ctx.clearRect(0, 0, canvas.width, canvas.height); // –û—á–∏—â–∞–µ–º —Ö–æ–ª—Å—Ç
       ctx.drawImage(img, 0, 0, canvas.width, canvas.height); // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
       drawMarkers(ctx, plane); // –†–∏—Å—É–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
     };
     img.src = `/api/dicom/reconstruct/${plane}?index=${idx}&t=${Date.now()}`;
   }
   
   // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫
   function drawMarkers(ctx, plane) {
     markers[plane].forEach(marker => {
       ctx.beginPath();
       ctx.arc(marker.x, marker.y, 5, 0, 2 * Math.PI);
       ctx.fillStyle = "red";
       ctx.fill();
     });
   }
   
   function addMarker(e, plane) {
  const canvas = e.target;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  markers[plane].push({ x, y });
  drawMarkers(canvas.getContext('2d'), plane);

  compute3DIntersections(); // <--- –í—ã–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
}
   

   function compute3DIntersections() {
  const axialIndex = parseInt(document.getElementById('axial').value);
  const sagittalIndex = parseInt(document.getElementById('sagittal').value);
  const coronalIndex = parseInt(document.getElementById('coronal').value);

  // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –º—ã –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –º–µ—Ç–∫—É –∏–∑ –∫–∞–∂–¥–æ–≥–æ
  const axialMarker = markers.axial[markers.axial.length - 1];
  const sagittalMarker = markers.sagittal[markers.sagittal.length - 1];
  const coronalMarker = markers.coronal[markers.coronal.length - 1];

  if (axialMarker && sagittalMarker && coronalMarker) {
    const x_from_sagittal = sagittalIndex;
    const y_from_axial = axialMarker.y;
    const z_from_axial = axialIndex;

    const x_from_coronal = coronalMarker.x;
    const z_from_coronal = coronalMarker.y;

    const y_from_sagittal = sagittalMarker.y;
    const z_from_sagittal = sagittalMarker.x;

    // –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —É—Å—Ä–µ–¥–Ω–∏—Ç—å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    const x = Math.round((x_from_sagittal + x_from_coronal) / 2);
    const y = Math.round((y_from_axial + y_from_sagittal) / 2);
    const z = Math.round((z_from_axial + z_from_coronal + z_from_sagittal) / 3);

    console.log("üéØ –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤:", { x, y, z });

    // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ü–∏—è—Ö
    drawCrossOnSlices({ x, y, z });
  }
}
function drawCrossOnSlices(point3D) {
  const canvases = {
    axial: document.getElementById('canvas-axial'),
    sagittal: document.getElementById('canvas-sagittal'),
    coronal: document.getElementById('canvas-coronal')
  };

  // –û—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–µ—Ç–∫–∏
  Object.entries(canvases).forEach(([plane, canvas]) => {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    update(plane); // –ó–∞–Ω–æ–≤–æ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –º–∞—Ä–∫–µ—Ä—ã

    ctx.strokeStyle = 'lime';
    ctx.lineWidth = 1;

    ctx.beginPath();
    if (plane === 'axial') {
      ctx.moveTo(0, point3D.y);
      ctx.lineTo(512, point3D.y);
      ctx.moveTo(point3D.x, 0);
      ctx.lineTo(point3D.x, 512);
    } else if (plane === 'sagittal') {
      ctx.moveTo(0, point3D.y);
      ctx.lineTo(512, point3D.y);
      ctx.moveTo(point3D.z, 0);
      ctx.lineTo(point3D.z, 512);
    } else if (plane === 'coronal') {
      ctx.moveTo(0, point3D.z);
      ctx.lineTo(512, point3D.z);
      ctx.moveTo(point3D.x, 0);
      ctx.lineTo(point3D.x, 512);
    }
    ctx.stroke();
  });
}

   document.getElementById('canvas-axial').addEventListener('click', (e) => addMarker(e, 'axial'));
   document.getElementById('canvas-sagittal').addEventListener('click', (e) => addMarker(e, 'sagittal'));
   document.getElementById('canvas-coronal').addEventListener('click', (e) => addMarker(e, 'coronal'));
   
   // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ä–µ–∑–æ–≤
   ['axial', 'sagittal', 'coronal'].forEach(update);
   
</script>

</body>
</html>
